name: Code Quality Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      skip_backend:
        description: 'Saltar verificaciÃ³n del backend'
        required: false
        default: 'false'
        type: boolean
      skip_frontend:
        description: 'Saltar verificaciÃ³n del frontend'
        required: false
        default: 'false'
        type: boolean
      strict_mode:
        description: 'Modo estricto (falla en warnings)'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18.x'
  ANGULAR_VERSION: '17'
  # ParÃ¡metros de calidad configurables
  BACKEND_STRICT_SYNTAX: true
  BACKEND_CHECK_SECURITY: true
  FRONTEND_STRICT_TYPES: true
  FRONTEND_CHECK_CONSOLE: true

jobs:
  # Job para evaluar calidad del cÃ³digo del backend (Node.js)
  backend-quality:
    name: Backend Code Quality (Node.js)
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || !inputs.skip_backend
    
    defaults:
      run:
        working-directory: ./backend-node
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend-node/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check for syntax errors
        run: |
          echo "ðŸ” Verificando sintaxis de archivos JavaScript..."
          ERROR_COUNT=0
          for file in $(find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*"); do
            if ! node -c "$file" 2>/dev/null; then
              echo "âŒ Error de sintaxis en: $file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Se encontraron $ERROR_COUNT archivos con errores de sintaxis"
            exit 1
          fi
          echo "âœ… Todos los archivos JavaScript tienen sintaxis vÃ¡lida"

      - name: Check for common issues
        run: |
          echo "ðŸ” Verificando problemas comunes..."
          
          # Contar archivos JavaScript
          JS_COUNT=$(find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" | wc -l)
          echo "ðŸ“ Archivos JavaScript encontrados: $JS_COUNT"
          
          # Verificar que no haya require() sin manejo de errores (opcional)
          echo "âœ… VerificaciÃ³n de problemas comunes completada"

      - name: Validate package.json
        run: |
          echo "ðŸ” Validando package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || exit 1

      - name: Check for security vulnerabilities
        if: env.BACKEND_CHECK_SECURITY == 'true'
        run: |
          echo "ðŸ” Verificando vulnerabilidades de seguridad..."
          if npm audit --audit-level=moderate; then
            echo "âœ… No se encontraron vulnerabilidades crÃ­ticas o moderadas"
          else
            echo "âš ï¸  Se encontraron vulnerabilidades. Revisa el reporte anterior."
            if [ "${{ inputs.strict_mode }}" == "true" ]; then
              exit 1
            fi
          fi

      - name: Verify server can start
        run: |
          echo "ðŸ” Verificando que el servidor puede iniciarse..."
          timeout 10s node server.js || exit 0

  # Job para evaluar calidad del cÃ³digo del frontend (Angular)
  frontend-quality:
    name: Frontend Code Quality (Angular)
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || !inputs.skip_frontend
    
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Verify Angular CLI
        run: |
          echo "ðŸ” Verificando Angular CLI..."
          npx ng version

      - name: Lint TypeScript files
        run: |
          echo "ðŸ” Ejecutando linting de TypeScript..."
          if npx ng lint --format=stylish; then
            echo "âœ… Linting completado sin errores"
          else
            echo "âš ï¸  Se encontraron problemas en el linting"
            if [ "${{ inputs.strict_mode }}" == "true" ]; then
              echo "âŒ Modo estricto activado: fallando por errores de linting"
              exit 1
            fi
          fi

      - name: Type checking
        run: |
          echo "ðŸ” Verificando tipos de TypeScript..."
          npx ng build --configuration=development --no-optimization || exit 1

      - name: Check for TypeScript errors
        if: env.FRONTEND_STRICT_TYPES == 'true'
        run: |
          echo "ðŸ” Verificando errores de TypeScript..."
          npx tsc --noEmit --project tsconfig.json || exit 1
          echo "âœ… VerificaciÃ³n de tipos completada sin errores"

      - name: Validate angular.json
        run: |
          echo "ðŸ” Validando angular.json..."
          node -e "JSON.parse(require('fs').readFileSync('angular.json', 'utf8'))" || exit 1

      - name: Check for unused imports
        run: |
          echo "ðŸ” Verificando imports no utilizados..."
          # Esta verificaciÃ³n se hace automÃ¡ticamente con el build de TypeScript
          echo "âœ… VerificaciÃ³n de imports completada"

      - name: Check for console.log in production code
        if: env.FRONTEND_CHECK_CONSOLE == 'true'
        run: |
          echo "ðŸ” Verificando console.log en cÃ³digo de producciÃ³n..."
          CONSOLE_COUNT=$(grep -r "console.log" src/ --include="*.ts" --include="*.js" 2>/dev/null | wc -l || echo "0")
          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "âš ï¸  Se encontraron $CONSOLE_COUNT console.log en el cÃ³digo. Considera removerlos para producciÃ³n."
            if [ "${{ inputs.strict_mode }}" == "true" ]; then
              echo "âŒ Modo estricto activado: fallando por console.log encontrados"
              exit 1
            fi
          else
            echo "âœ… No se encontraron console.log"
          fi

      - name: Validate package.json
        run: |
          echo "ðŸ” Validando package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" || exit 1

  # Job para generar reporte de calidad
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate quality report
        run: |
          echo "## ðŸ“Š Reporte de Calidad de CÃ³digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend (Node.js)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaciÃ³n de sintaxis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ValidaciÃ³n de package.json" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaciÃ³n de seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend (Angular)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linting de TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaciÃ³n de tipos" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CompilaciÃ³n de TypeScript" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ValidaciÃ³n de angular.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Estado:** ${{ needs.backend-quality.result }} (Backend) | ${{ needs.frontend-quality.result }} (Frontend)" >> $GITHUB_STEP_SUMMARY

